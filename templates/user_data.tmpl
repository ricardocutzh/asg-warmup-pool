#!/bin/bash

# adding a change

sudo apt update

sudo apt install -y apt-transport-https ca-certificates curl software-properties-common

sudo apt install -y unzip

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"

sudo apt update

sudo apt install -y docker-ce

sudo usermod -aG docker $USER

su - $USER

sudo apt install -y awscli

sudo wget https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/debian_amd64/amazon-ssm-agent.deb

sudo snap remove amazon-ssm-agent && sudo dpkg -i amazon-ssm-agent.deb

sudo systemctl enable amazon-ssm-agent

cd /tmp

sudo aws s3 sync s3://${bucket_name} .

sudo unzip app.zip

ID=$(curl  http://169.254.169.254/latest/meta-data/instance-id)

sudo docker build --build-arg INSTANCE_ID=$ID -t simple:app .

sudo docker run -d --restart=always -p 8080:80 simple:app